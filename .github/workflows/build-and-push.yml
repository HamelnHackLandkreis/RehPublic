name: Build

on:
  push:
    branches: [main]
    tags:
      - "*"
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi

      - name: Build with Docker Bake
        uses: docker/bake-action@v5
        with:
          files: docker-bake.hcl
          push: false
          set: |
            backend.tags=backend:${{ steps.tag.outputs.tag }},backend:latest
            frontend.tags=frontend:${{ steps.tag.outputs.tag }},frontend:latest
            IMAGE_TAG=${{ steps.tag.outputs.tag }}
          cache-from: |
            type=gha,scope=backend
            type=gha,scope=frontend
          cache-to: |
            type=gha,scope=backend,mode=max
            type=gha,scope=frontend,mode=max
