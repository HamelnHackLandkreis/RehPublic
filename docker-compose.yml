services:
  # --- Frontend Service (Updated to point to Load Balancer) ---
  nuxt-frontend:
    build:
      context: ./frontend
      # Frontend now talks to the 'loadbalancer' service's internal port (80)
      args:
        - NUXT_PUBLIC_API_URL=https://rehpublic-api.3ggert.de
    ports:
      - "9001:80"
    restart: always
    container_name: rehpublic-frontend

  # --- Load Balancer Service (New) ---
  loadbalancer:
    image: nginx:stable-alpine
    container_name: rehpublic-loadbalancer
    # Removed 'user: root' as it is less secure and didn't solve the permission issue.
    ports:
      # This exposes port 9002 on the host, which will distribute traffic to the backends
      - "9002:80"
    volumes:
      # FIX: Mount the custom NGINX configuration to the main config file path
      # (/etc/nginx/nginx.conf) to avoid permission conflicts
      # with the default includes path (/etc/nginx/conf.d/default.conf).
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    # Ensure the load balancer starts only after the backends are running
    depends_on:
      - backend-1
      - backend-2
      - backend-3
      - backend-4
    restart: always

  # --- Backend Services (4 Replicas) ---
  backend-1:
    build:
      context: ./backend
    # We do not expose 8000 here as only the load balancer needs to reach it
    container_name: rehpublic-backend-1
    restart: always
    environment:
      - REDIS_URL=redis://redis:6379/0
    # Wait for the database to be ready before starting
    depends_on:
      - db
      - redis

  backend-2:
    build:
      context: ./backend
    container_name: rehpublic-backend-2
    restart: always
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis

  backend-3:
    build:
      context: ./backend
    container_name: rehpublic-backend-3
    restart: always
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis

  backend-4:
    build:
      context: ./backend
    container_name: rehpublic-backend-4
    restart: always
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis

  # --- Database Service (Unchanged) ---
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD: hamelnhack2025
      POSTGRES_DB: rehpublic
      POSTGRES_USER: rehpublic
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # --- Redis Service (New) ---
  redis:
    image: redis:7-alpine
    container_name: rehpublic-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # --- Celery Worker Service (New) ---
  celery-worker:
    build:
      context: ./backend
    container_name: rehpublic-celery-worker
    command: celery -A src.celery_app worker --loglevel=info --concurrency=2
    restart: always
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
      - db
    volumes:
      - ./backend/models:/app/models

volumes:
  postgres_data:
  redis_data:
